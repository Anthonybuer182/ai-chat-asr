<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 页面元数据配置 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    
    <!-- 图标和样式表 -->
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 页面标题 -->
    <title>AI语音聊天系统</title>
    
    <!-- 内联CSS样式定义 -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            height: 90vh;
            max-height: 800px;
            display: flex;
            flex-direction: column;
        }
        
        /* Header布局样式 */
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
        }
        
        .app-title {
            font-size: 24px;
            font-weight: 800;
            color: white;
            margin: 0;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            letter-spacing: 0.5px;
        }
        
        /* 右侧控制组件样式 */
        .header-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* 语言选择器样式 */        
        .language-btn {
            padding: 8px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 32px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            min-width: 60px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            box-sizing: border-box;
        }
        
        .language-btn:hover {
            border-color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
        }
        
        .language-btn.active {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
        }
  /* 自定义TTS选择器组件 */
        .custom-tts-selector {
            position: relative;
            min-width: 120px;
        }
        
        .custom-tts-select {
            padding: 8px 40px 8px 16px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%);
            color: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(12px);
            outline: none;
            min-width: 100px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .custom-tts-select:hover {
            border-color: rgba(255, 255, 255, 0.8);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.15) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 255, 255, 0.3);
        }
        
        .custom-tts-select.active {
            border-color: rgba(255, 255, 255, 0.9);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.2) 100%);
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.15);
            border-radius: 20px 20px 0 0;
        }
        
        /* 自定义下拉箭头 */
        .custom-tts-selector::after {
            content: '▼';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.8);
            font-size: 10px;
            pointer-events: none;
            transition: transform 0.3s ease;
        }
        
        .custom-tts-selector.active::after {
            transform: translateY(-50%) rotate(180deg);
        }
        
        /* 自定义下拉菜单 */
        .custom-tts-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 0 0 20px 20px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-top: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            z-index: 99;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .custom-tts-dropdown.active {
            display: block;
        }
        
        .custom-tts-option {
            padding: 12px 16px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .custom-tts-option:last-child {
            border-bottom: none;
        }
        
        .custom-tts-option:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateX(5px);
        }
        
        .custom-tts-option.selected {
            background: linear-gradient(135deg, #4a5fcf 0%, #5d3785 100%);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        /* 自定义滚动条 */
        .custom-tts-dropdown::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-tts-dropdown::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .custom-tts-dropdown::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 3px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
            scroll-behavior: smooth;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .message {
            margin-bottom: 0;
            display: flex;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            border-radius: 18px 0px 18px 18px;
        }
        
        .message.assistant .message-content {
            background: white;
            border: 1px solid #e9ecef;
            color: #212529;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 0px 18px 18px 18px;
        }
        
        .status-indicator {
            padding: 10px;
            text-align: center;
            font-size: 14px;
            color: #6c757d;
            background: #f8f9fa;
            transition: all 0.3s ease;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .status-indicator.connected {
            color: #28a745;
        }
        
        .status-indicator.disconnected {
            color: #dc3545;
        }
        
        /* 移动端响应式优化 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                height: 96vh;
                border-radius: 16px;
            }
            
            
            .chat-messages {
                padding: 15px;
            }
              
            .message-content {
                max-width: 85%;
            }
               
    }   
        /* 思考指示器 - 三个点动画 */
        .thinking-dots {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 0;
            height: 16px; /* 匹配文本行高 */
        }
        
        .thinking-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #6c757d;
            animation: thinking 1.4s ease-in-out infinite;
        }
        .thinking-dot-assitant {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #f8f9fa;
            animation: thinking 1.4s ease-in-out infinite;
        }
        
        .thinking-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .thinking-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes thinking {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* 连接状态动画 */
        .status-indicator.connected::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            margin-right: 8px;
            animation: blink 2s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        /* 用户语音消息指示器 */
        .user-voice-message-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 18px 18px 0px 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            color: white;
        }
        
        /* 助手语音消息指示器 */
        .assistant-voice-message-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 18px 18px 18px 0px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            color: #212529;
        }
        
        .user-voice-message-indicator:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        
        .assistant-voice-message-indicator:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .user-voice-message-indicator .play-btn {
            color: white;
        }
        
        .assistant-voice-message-indicator .play-btn {
            color: #667eea;
        }
        
        .user-voice-message-indicator.playing .play-btn {
            color: #ff6b6b;
        }
        
        .assistant-voice-message-indicator.playing .play-btn {
            color: #dc3545;
        }
        
        /* 错误状态样式 */
        .user-voice-message-indicator.error .play-btn,
        .assistant-voice-message-indicator.error .play-btn {
            color: #ffc107;
            animation: pulseError 0.6s ease-in-out 3;
        }
        
        @keyframes pulseError {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* 播放按钮悬停效果 */
        .user-voice-message-indicator:hover .play-btn,
        .assistant-voice-message-indicator:hover .play-btn {
            transform: scale(1.05);
            transition: all 0.2s ease;
        }
        
        /* 播放状态动画 */
        .user-voice-message-indicator.playing,
        .assistant-voice-message-indicator.playing {
            animation: pulsePlaying 2s infinite;
        }
        
        @keyframes pulsePlaying {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.02);
                opacity: 0.9;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1 class="app-title" id="appTitle">AI语音聊天系统</h1>
                <!-- 右侧控制组件 -->
                <div class="header-controls">
                    <!-- 语言选择器 -->
                    <button class="language-btn" id="languageToggle" onclick="toggleLanguage()">
                        中
                    </button>
                    <!-- 自定义TTS引擎选择器 -->
                    <div class="custom-tts-selector" id="customTtsSelector">
                        <div class="custom-tts-select" id="customTtsSelect">pyttsx3</div>
                        <div class="custom-tts-dropdown" id="customTtsDropdown">
                            <div class="custom-tts-option" data-value="pyttsx3">pyttsx3</div>
                            <div class="custom-tts-option" data-value="gtts">gTTS</div>
                            <div class="custom-tts-option" data-value="edgetts">EdgeTTS</div>
                            <div class="custom-tts-option" data-value="elevenlabs">ElevenLabs</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- 共享状态指示器和消息区域 -->
        <div class="status-indicator" id="status">
            连接状态：未连接
        </div>
        <div class="chat-messages" id="messages"></div>
    </div>
    
    <!-- 颜色插值函数 -->
    <script type="module">
        import { interpolateInferno } from "https://cdn.skypack.dev/d3-scale-chromatic@3";
        window.interpolateInferno = interpolateInferno;
    </script>
    
    <script>
        let ws = null;
        let recorder = null;
        let player = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const RECONNECT_DELAY = 3000;
        let currentLanguage = 'zh';  // 当前语言：'zh' 或 'en'
        let currentTtsEngine = null;  // 获取当前TTS引擎值（带缓存优化）
      
        // 初始化
        function init() {
            // 从localStorage加载保存的语言选择
            const savedLanguage = localStorage.getItem('selectedLanguage');
            if (savedLanguage) {
                currentLanguage = savedLanguage;
            }
            connectWebSocket();
            setupCustomLanguageSelector(currentLanguage);
            setupCustomTtsSelector();
        }        

        
        // 切换语言
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
            
            // 保存到localStorage
            localStorage.setItem('selectedLanguage', currentLanguage);
            // 更新界面文本
            setupCustomLanguageSelector(currentLanguage);
        }
        
        // 更新界面语言
        function setupCustomLanguageSelector(lang) {
            const languageBtn = document.getElementById('languageToggle');
            languageBtn.textContent = lang === 'zh' ? '中' : 'EN';
            languageBtn.setAttribute('aria-label', lang === 'zh' ? '切换到英文' : 'Switch to Chinese');
            const elements = {
                'app-title': lang === 'zh' ? 'AI语音聊天系统' : 'AI Voice Chat System',
            };
            
            // 更新元素文本
            document.getElementById('appTitle').textContent = elements['app-title'];
            
            // 更新状态指示器（现在使用共享的status）
            const status = document.getElementById('status');
            
            // 更新状态的双语文本（同时检查中英文状态）
            if (status.textContent.includes('已连接') || status.textContent.includes('Connected')) {
                status.textContent = lang === 'zh' ? '连接状态：已连接' : 'Status: Connected';
            } else if (status.textContent.includes('已断开') || status.textContent.includes('Disconnected')) {
                status.textContent = lang === 'zh' ? '连接状态：已断开' : 'Status: Disconnected';
            } else if (status.textContent.includes('连接错误') || status.textContent.includes('Connection Error')) {
                status.textContent = lang === 'zh' ? '连接状态：连接错误' : 'Status: Connection Error';
            } else if (status.textContent.includes('尝试重新连接') || status.textContent.includes('Attempting to reconnect')) {
                const matches = status.textContent.match(/(?:尝试重新连接|Attempting to reconnect) \((\d+)\/(\d+)\)\.\.\./);
                if (matches) {
                    status.textContent = lang === 'zh' ? `尝试重新连接 (${matches[1]}/${matches[2]})...` : `Attempting to reconnect (${matches[1]}/${matches[2]})...`;
                }
            } else if (status.textContent.includes('连接失败') || status.textContent.includes('Connection failed')) {
                status.textContent = lang === 'zh' ? '连接失败，请刷新页面重试' : 'Connection failed, please refresh the page';
            }
        }

        
        // 统一WebSocket连接函数
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/chat`);
    
            ws.onopen = () => {
                updateStatus('status', '已连接', true);
                reconnectAttempts = 0;
                recorder = new WebRecorder(ws);
                player = new AudioPlayer(updateStatus, ws);
                console.log('WS连接成功');
            };
        
            ws.onmessage = async (event) => {
                const data = JSON.parse(event.data);// 现在使用共享的messages
                console.log('WS消息接收:', data);
                if (typeof data === 'string') {
                    if (data.type === 'error') {
                        handleErrorMessage(data);
                    }else if (data.type === 'text') {
                        handleTextMessage(data);
                    }
                }else{
                    const audioData = event.data; // ArrayBuffer
                    player.playAudio(audioData);
                }
                
            };
                       
            ws.onerror = (error) => {
                console.error('WebSocket连接错误:', error);
                updateStatus('status', '连接错误', false);
            };
            
            ws.onclose = () => {
                updateStatus('status', '已断开', false);
                attemptReconnect(() => connectWebSocket());
            };
        }
        

        
        // 尝试重新连接
        function attemptReconnect(connectFunction) {
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                reconnectAttempts++;
                const delay = RECONNECT_DELAY * Math.pow(2, reconnectAttempts - 1);
                
                // 使用状态映射表中的键来确保双语支持（现在使用共享的status）
                updateStatus('status', 
                           `尝试重新连接 (${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})...`, false);
                
                setTimeout(() => {
                    connectFunction();
                }, delay);
            } else {
                updateStatus('status', 
                           '连接失败，请刷新页面重试', false);
            }
        }
        
        class WebRecorder {
            constructor(ws) {
                this.ws = ws;
                this.audioContext = null;
                this.processor = null;
                this.source = null;
                this.stream = null;
                this.isRecording = false;
                this.log = document.getElementById('logContainer');

                // 配置参数
                this.inputSampleRate = 48000;  // 大多数浏览器默认采样率
                this.outputSampleRate = 16000; // 你需要的采样率
            }

            // 采样率转换（降采样）
            downsampleBuffer(buffer, inputSampleRate, outputSampleRate) {
                if (outputSampleRate === inputSampleRate) {
                    return buffer;
                }
                const sampleRateRatio = inputSampleRate / outputSampleRate;
                const newLength = Math.round(buffer.length / sampleRateRatio);
                const result = new Float32Array(newLength);
                let offsetResult = 0;
                let offsetBuffer = 0;
                while (offsetResult < result.length) {
                    const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
                    // 对应多个输入样本的平均值
                    let accum = 0, count = 0;
                    for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                        accum += buffer[i];
                        count++;
                    }
                    result[offsetResult] = accum / count;
                    offsetResult++;
                    offsetBuffer = nextOffsetBuffer;
                }
                return result;
            }

            // float32 转 int16
            floatTo16BitPCM(input) {
                const output = new Int16Array(input.length);
                for (let i = 0; i < input.length; i++) {
                    let s = Math.max(-1, Math.min(1, input[i]));
                    output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                }
                return output;
            }

            async start() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();

                    // 连接麦克风流
                    this.source = this.audioContext.createMediaStreamSource(this.stream);

                    // 处理节点，bufferSize 可以是 256、512、1024、2048、4096、8192、16384
                    const bufferSize = 4096;
                    this.processor = this.audioContext.createScriptProcessor(bufferSize, 1, 1);

                    this.processor.onaudioprocess = (e) => {
                        if (!this.isRecording) return;

                        let inputData = e.inputBuffer.getChannelData(0); // Float32Array

                        // 先降采样到16kHz
                        let downsampledBuffer = this.downsampleBuffer(inputData, this.audioContext.sampleRate, this.outputSampleRate);

                        // 转16bit PCM
                        let int16Buffer = this.floatTo16BitPCM(downsampledBuffer);

                        // 发送二进制数据
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(int16Buffer.buffer);
                        }
                    };

                    // 连接处理节点到输出（避免垃圾收集）
                    this.source.connect(this.processor);
                    this.processor.connect(this.audioContext.destination);

                    this.isRecording = true;
                    return true;
                } catch (error) {
                    return false;
                }
            }

            stop() {
                if (!this.isRecording) return;

                this.isRecording = false;

                if (this.processor) {
                    this.processor.disconnect();
                    this.processor = null;
                }
                if (this.source) {
                    this.source.disconnect();
                    this.source = null;
                }
                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
            }
        }

        class AudioPlayer {
            constructor(updateStatus, websocket) {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.audioQueue = [];
                this.isPlaying = false;
                this.shouldInterrupt = false;
                this.updateStatus = updateStatus;
                this.websocket = websocket
            }

             sendPlaybackStatus(status, queueSize) {
                if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                    const message = {
                        type: "playback_status",
                        status: status, // e.g., 'playing', 'interrupted' , 'completed'
                        queue_size: queueSize,
                        timestamp: new Date().toISOString()
                    };
                    this.websocket.send(JSON.stringify(message));
                }
            }

            async playAudio(audioData) {
                try {
                    const audioBuffer = await this.audioContext.decodeAudioData(audioData);
                    this.audioQueue.push(audioBuffer);
                    console.log(`收到音频, 队列大小: ${this.audioQueue.length}`);
                    if (!this.isPlaying) {
                        this.playNext();
                    }
                } catch (error) {
                    console.error(`播放错误: ${error}`);
                }
            }

            playNext() {
                if (this.audioQueue.length === 0) {
                    this.isPlaying = false;
                    return;
                }

                this.isPlaying = true;
                const audioBuffer = this.audioQueue.shift();
                const source = this.audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(this.audioContext.destination);
                this.source = source;  // <== 添加这句


                const duration = audioBuffer.duration.toFixed(1);
                console.log(`开始播放 (时长: ${duration}秒)`);
                this.updateStatus(`status`,`播放中 (剩余: ${this.audioQueue.length + 1}段)`, true);
                this.sendPlaybackStatus('playing', this.audioQueue.length);
                source.onended = () => {
                    console.log("播放完成");
                    if (this.shouldInterrupt){
                        this.sendPlaybackStatus('interrupted', this.audioQueue.length);
                    } else {
                        this.sendPlaybackStatus('completed', this.audioQueue.length);
                    }
                    if (this.audioQueue.length > 0) {
                        this.playNext();
                    } else {
                        this.isPlaying = false;
                        this.shouldInterrupt = false;

                        if (this.audioQueue.length === 0) {
                            this.updateStatus(`status`,"就绪",true);
                        }
                    }
                };

                source.start();
            }

            stopCurrent() {
                if (this.source) {
                    try {
                        this.source.stop();
                    } catch (e) {
                        console.error(`停止当前音频错误: ${e}`);
                    }
                    this.source = null;
                }
                this.isPlaying = false;
            }

            interrupt() {
                this.shouldInterrupt = true;
                this.audioQueue = [];
                this.stopCurrent();  // <== 添加这一句
                console.log("收到打断指令，清空播放队列并停止当前音频");
                this.updateStatus(`status`,"已打断",true);
            }
        }
    
        // 统一的消息流式更新函数 - 优化支持后端status字段
        let currentStreamMessages = {};
        
        function handleTextMessage(data) {
            const { role,type, content, status, message_id } = data;
            const messagesDiv = document.getElementById('messages');
            const messageKey = `${messagesDiv.id}_${role}_${message_id || 'default'}`;
            // 处理start状态 - 开始新的消息流
            if (status === 'start') {
                // 创建新的消息元素
                currentStreamMessages[messageKey] = document.createElement('div');
                currentStreamMessages[messageKey].className = `message ${role}`;
                
                // 根据角色设置不同的思考指示器
                const dotClass = role === 'user' ? 'thinking-dot-assitant' : 'thinking-dot';
                
                currentStreamMessages[messageKey].innerHTML = `
                    <div class="message-content">
                        <div class="thinking-dots">
                            <div class="${dotClass}"></div>
                            <div class="${dotClass}"></div>
                            <div class="${dotClass}"></div>
                        </div>
                    </div>
                `;
                messagesDiv.appendChild(currentStreamMessages[messageKey]);
                
                console.log(`创建新消息流: ${messageKey}`);
            }
            
            // 处理continue状态 - 更新消息内容
            else if (status === 'continue' && type === 'text' && currentStreamMessages[messageKey]) {
                const messageContent = currentStreamMessages[messageKey].querySelector('.message-content');
                if (messageContent) {
                    const thinkingDots = messageContent.querySelector('.thinking-dots');
                    // 如果有内容需要显示
                    if (content && content.trim() !== '') {
                        // 如果思考指示器还存在，先移除它
                        if (thinkingDots && thinkingDots.parentNode) {
                            thinkingDots.remove();
                        }
                        
                        // 获取或创建文本元素
                        let textElement = messageContent.querySelector('span');
                        if (!textElement) {
                            textElement = document.createElement('span');
                            messageContent.appendChild(textElement);
                        }
                        textElement.textContent += content;
                    }
                }
            }
            
            // 处理end状态 - 结束消息流
            else if (status === 'end' && currentStreamMessages[messageKey]) {
                const messageContent = currentStreamMessages[messageKey].querySelector('.message-content');
                if (messageContent) {
                    // 移除可能存在的思考指示器
                    const thinkingDots = messageContent.querySelector('.thinking-dots');
                    if (thinkingDots && thinkingDots.parentNode) {
                        thinkingDots.remove();
                        
                        // 如果没有内容，添加一个空文本元素
                        if (!messageContent.querySelector('span')) {
                            const textElement = document.createElement('span');
                            messageContent.appendChild(textElement);
                            if (content && content.trim() !== '') {
                                textElement.textContent += content;
                            }
                        }
                    }
                }
                
                // 清理消息流状态
                delete currentStreamMessages[messageKey];
                console.log(`结束消息流: ${messageKey}`);
            }
            
            // 确保消息容器滚动到底部
            if (currentStreamMessages[messageKey]) {
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        // 添加语音消息（语音指示器直接作为消息）- 优化消息关联逻辑
        function addVoiceMessage(role, messageId = null, base64Audio = null) {
            const messageKey = `${messageId}_${role}`;
            const isUser = role === 'user';
            const cssClass = isUser ? 'user-voice-message-indicator' : 'assistant-voice-message-indicator';
            
            const voiceElement = `
                <div class="${cssClass}" id="${messageKey}" onclick="toggleAudioPlayback('${messageKey}', '${base64Audio}')">
                    <div class="play-btn">
                        <i class="fas fa-play"></i>
                    </div>
                </div>
            `;
            
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = voiceElement;
            
            // 语音消息插入到消息列表的末尾（最后一条消息的上方）
            const lastChild = messagesDiv.lastChild;
            if (lastChild&&role==='assistant') {
                messagesDiv.insertBefore(messageDiv, lastChild);
            } else {
                messagesDiv.appendChild(messageDiv);
            }
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // 更新状态（支持双语）
        function updateStatus(statusId, text, isConnected) {
            const status = document.getElementById(statusId);
            
            // 状态文本的双语映射
            const statusTextMap = {
                '已连接': currentLanguage === 'zh' ? '已连接' : 'Connected',
                '已断开': currentLanguage === 'zh' ? '已断开' : 'Disconnected',
                '连接错误': currentLanguage === 'zh' ? '连接错误' : 'Connection Error',
                '尝试重新连接': currentLanguage === 'zh' ? '尝试重新连接' : 'Attempting to reconnect',
                '连接失败，请刷新页面重试': currentLanguage === 'zh' ? '连接失败，请刷新页面重试' : 'Connection failed, please refresh the page',
                '已连接 - 可以开始说话': currentLanguage === 'zh' ? '已连接 - 可以开始说话' : 'Connected - You can start speaking'
            };
            
            // 获取对应的双语文本，如果没有映射则使用原文本
            const localizedText = statusTextMap[text] || text;
            status.textContent = localizedText;
            status.className = `status-indicator ${isConnected ? 'connected' : 'disconnected'}`;
        }
        
        function handleAudioMessage(data) {
            const { role, type, content, status, message_id } = data;
            if (type === 'audio') {
                // 处理开始音频消息 - 创建语音消息指示器
                addVoiceMessage(role, message_id, content);
                toggleAudioPlayback(`${message_id}_${role}`, content);
            }
        }
        
          // 音频播放控制
        let currentAudio = null;
        let currentAudioElement = null;
        function toggleAudioPlayback(messageKey, base64Audio) {
            const audioElement = document.getElementById(messageKey);
            // 如果正在播放当前音频，则停止
            if (currentAudioElement === audioElement && currentAudio) {
                stopAudioPlayback();
                return;
            }
            
            // 如果正在播放其他音频，先停止
            if (currentAudio) {
                stopAudioPlayback();
            }
            
            // 开始播放新音频
            updateAudioPlaybackButton(messageKey, true);
            startAudioPlayback(audioElement, base64Audio);
        }
        
        // 开始音频播放 - 修复版本
        async function startAudioPlayback(audioElement, base64Audio) {
            try {
                currentAudio = new Audio('data:audio/mp3;base64,' + base64Audio);
                // 设置音频事件
                currentAudio.onended = () => {
                    stopAudioPlayback();
                };
                
                currentAudio.onerror = (error) => {
                    console.error('音频播放错误:', error);
                    stopAudioPlayback();
                };
                
                // 开始播放
                currentAudio.play().catch(error => {
                    console.error('播放失败:', error);
                    stopAudioPlayback();
                });
                currentAudioElement = audioElement;
            } catch (error) {
                console.error('创建音频失败:', error);
                stopAudioPlayback();
            }
        }
            
        function stopAudioPlayback() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            
            if (currentAudioElement) {
                currentAudioElement.classList.remove('playing');
                const playIcon = currentAudioElement.querySelector('.play-btn i');
                playIcon.className = 'fas fa-play';
                currentAudioElement = null;
            }
        }
            
            // 更新音频播放按钮状态
            function updateAudioPlaybackButton(messageKey, isPlaying) {
                const audioElement = document.getElementById(messageKey);
                if (audioElement) {
                    const playBtn = audioElement.querySelector('.play-btn i');
                    if (playBtn) {
                        if (isPlaying) {
                            audioElement.classList.add('playing');
                            playBtn.className = 'fas fa-stop';
                        } else {
                            audioElement.classList.remove('playing');
                            playBtn.className = 'fas fa-play';
                        }
                    }
                }
            }
        // 处理错误消息 - 优化错误处理和状态管理
        function handleErrorMessage(data) {
            console.error('WebSocket错误消息:', data);
            
            // 显示错误信息
            const errorMessage = data.content || '发生未知错误';
            showError(errorMessage);
        }
        
        // 显示错误消息
        function showError(message) {
            // 创建优雅的错误提示
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #dc3545;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                animation: slideInRight 0.3s ease;
            `;
            errorDiv.textContent = message;
            
            document.body.appendChild(errorDiv);
            
            // 3秒后自动消失
            setTimeout(() => {
                errorDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => errorDiv.remove(), 300);
            }, 3000);
        }
        

        function getCurrentTtsEngine() {
            // 如果缓存为空，从localStorage读取
            if (currentTtsEngine === null) {
                currentTtsEngine = localStorage.getItem('selectedTtsEngine') || 'pyttsx3';
            }
            return currentTtsEngine;
        }
        
        // 自定义TTS选择器功能
        function setupCustomTtsSelector() {
            const selector = document.getElementById('customTtsSelector');
            const select = document.getElementById('customTtsSelect');
            const dropdown = document.getElementById('customTtsDropdown');
            const options = dropdown.querySelectorAll('.custom-tts-option');
            
            // 从localStorage加载保存的TTS选择
            const savedTtsEngine = localStorage.getItem('selectedTtsEngine');
            if (savedTtsEngine) {
                currentTtsEngine = savedTtsEngine;
                const savedOption = dropdown.querySelector(`[data-value="${currentTtsEngine}"]`);
                if (savedOption) {
                    select.textContent = savedOption.textContent;
                    options.forEach(opt => opt.classList.remove('selected'));
                    savedOption.classList.add('selected');
                }
            }
            
            // 点击选择器切换下拉菜单
            select.addEventListener('click', function(e) {
                e.stopPropagation();
                const isActive = selector.classList.contains('active');
                
                // 关闭所有其他下拉菜单
                document.querySelectorAll('.custom-tts-selector').forEach(s => {
                    if (s !== selector) {
                        s.classList.remove('active');
                        s.querySelector('.custom-tts-dropdown').classList.remove('active');
                    }
                });
                
                // 切换当前下拉菜单
                selector.classList.toggle('active');
                dropdown.classList.toggle('active');
                
                if (!isActive) {
                    select.classList.add('active');
                } else {
                    select.classList.remove('active');
                }
            });
            
            // 点击选项
            options.forEach(option => {
                option.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const text = this.textContent;
                    
                    // 更新显示文本
                    select.textContent = text;
                    
                    // 更新选中状态
                    options.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    // 保存到localStorage并更新缓存
                    localStorage.setItem('selectedTtsEngine', value);
                    currentTtsEngine = value;
                    
                    // 关闭下拉菜单
                    selector.classList.remove('active');
                    dropdown.classList.remove('active');
                    select.classList.remove('active');
                });
            });
            
            // 点击页面其他区域关闭下拉菜单
            document.addEventListener('click', function(e) {
                if (!selector.contains(e.target)) {
                    selector.classList.remove('active');
                    dropdown.classList.remove('active');
                    select.classList.remove('active');
                }
            });
            
            // 阻止下拉菜单内的点击事件冒泡
            dropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // 初始化选中状态（如果没有保存的选择，使用默认值）
            const initialValue = savedTtsEngine || 'pyttsx3';
            const initialOption = dropdown.querySelector(`[data-value="${initialValue}"]`);
            if (initialOption) {
                initialOption.classList.add('selected');
                select.textContent = initialOption.textContent;
            }
        }
        
        // 页面加载完成后初始化
        window.addEventListener('load', function() {
            console.log('页面加载完成，开始初始化应用');
            init();
            console.log('应用初始化完成');
        });
        
        // 页面关闭时清理资源
        window.addEventListener('beforeunload', () => {
            console.log('页面即将关闭，开始清理资源');
            if (ws) {
                console.log('关闭WebSocket连接');
                ws.close();
            }
            console.log('资源清理完成');
        });
    </script>
</body>
</html>
